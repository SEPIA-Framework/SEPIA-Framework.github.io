<div id='sepiaFW-frame-carousel' class="sepiaFW-inner-container sepiaFW-carousel">
	<div class='sepiaFW-carousel-pane-container'>
		<!-- Page 1 -->
		<div id="sepiaFW-frame-page-1" class='sepiaFW-frames-page sepiaFW-carousel-pane'>
			<h3>STT Settings</h3>
			<p class="info-text">Here you can configure the connection to your STT server and set some engine parameters.</p>
			<p class="info-text">To learn how to run you own speech recognition server locally please visit: 
				<a href="https://github.com/SEPIA-Framework/sepia-stt-server" target=_blank>SEPIA STT Server</a>
			</p>
			<div class="group-container">
				<h3>Active Engine</h3>
				<div class="group">
					<label>ASR Engine:</label>
					<span id="sepiaFW-stt-settings-server-engine" class="string-value">---</span>
				</div>
				<h3>SEPIA STT Server</h3>
				<div class="group fill">
					<label>Server URL:</label>
					<input id="sepiaFW-stt-settings-server-url" type="url" placeholder="http://localhost:20741">
				</div>
				<div class="group fill">
					<label>User:</label>
					<input id="sepiaFW-stt-settings-server-user" placeholder="any">
				</div>
				<div class="group fill">
					<label>Auth. Token:</label>
					<input id="sepiaFW-stt-settings-server-token" type="password" placeholder="test1234">
				</div>
				<div class="group" style="justify-content: center;">
					<button id="sepiaFW-stt-settings-server-info-btn" 
						onclick="SepiaFW.frames.currentScope.showServerInfo();">Load Server Info</button>
				</div>
				<h3>ASR Engine</h3>
				<div class="group">
					<label>Model for selected language (<span id="sepiaFW-stt-settings-language"></span>):</label>
					<select id="sepiaFW-stt-settings-asr-model"></select>
				</div>
				<div class="group">
					<label>Optimize final result:</label>
					<div id="sepiaFW-stt-settings-opt-fr" title="Try to convert words to numbers for example (if supported)."></div>
				</div>
				<h3>Info</h3>
				<div id="sepiaFW-stt-settings-info-msg" style="width: 100%; white-space: break-spaces; word-wrap: break-word;"></div>
			</div>
		</div>
		<!-- Page 2 -->
		<div id="sepiaFW-frame-page-2" class='sepiaFW-frames-page sepiaFW-carousel-pane'>
			<h3>STT Debugging</h3>
			<p class="info-text">This page is supposed to help with finding STT issues.</p>
			<div class="group" style="justify-content: center;">
				<button id="sepiaFW-stt-settings-record-btn" 
					onclick="SepiaFW.frames.currentScope.toggleRecordingWithConfirmSound();">Toggle Recording</button>
				<button onclick="SepiaFW.frames.currentScope.resetRecognizer();">Reset Recognizer</button>
			</div>
			<h3>Info <button onclick="SepiaFW.frames.currentScope.clearSttDebugBox();">clear</button></h3>
			<div id="sepiaFW-stt-settings-debug-log" style="width: 100%; white-space: break-spaces; word-wrap: break-word; 
				overflow-y: auto; border: 1px solid #aaa; background: #111; color: #eee; 
				max-height: calc(100% - 200px); min-height: 135px; padding: 0 4px; font-size: 13px;"
			></div>
		</div>
	</div>
</div>
<div id="sepiaFW-frames-nav-bar" class='sepiaFW-layer-header'>
	<button id="sepiaFW-frames-close" class='entry'>
		<i class="material-icons md-btn2">&#xE5CD;</i>
	</button>
	<button id="sepiaFW-frames-show-prev-page" class='entry'>
		<i class="material-icons md-btn2">keyboard_arrow_left</i><span data-localize="back">back</span>
	</button>
	<button id="sepiaFW-frames-show-next-page" class='entry'>
		<span data-localize="next">next</span><i class="material-icons md-btn2">keyboard_arrow_right</i>
	</button>
	<div id="sepiaFW-frames-nav-bar-page-indicator"><div>&nbsp;</div><div>&nbsp;</div></div>
</div>
<script>
	$('#sepiaFW-frame-carousel').find('[data-localize]').each(function(){
		$(this).html(SepiaFW.local.g(this.dataset.localize));
	});
	
	//Define scope
	SepiaFW.frames.currentScope = {

		onFinishSetup: function(){
			SepiaFW.ui.onKeyboardInput('#sepiaFW-stt-settings-server-url', undefined, function(ele){
				SepiaFW.speechAudioProcessor.setSocketURI(ele.value);
				SepiaFW.debug.info("STT Server URL: " + ele.value);
			});
			SepiaFW.ui.onKeyboardInput('#sepiaFW-stt-settings-server-user', undefined, function(ele){
				SepiaFW.speechAudioProcessor.setServerUser(ele.value);
				SepiaFW.debug.info("STT Server user: " + ele.value);
			});
			SepiaFW.ui.onKeyboardInput('#sepiaFW-stt-settings-server-token', undefined, function(ele){
				SepiaFW.speechAudioProcessor.setServerToken(ele.value);
				SepiaFW.debug.info("STT Server token set");
			});
			$('#sepiaFW-stt-settings-asr-model').off().on("change", function(){
				SepiaFW.debug.info("STT Server ASR model: " + this.value);
				SepiaFW.speechAudioProcessor.setAsrModel(this.value);
			});
			var optimizeFinalResultToggle = document.getElementById('sepiaFW-stt-settings-opt-fr');
			optimizeFinalResultToggle.appendChild(SepiaFW.ui.build.toggleButton(
				'sepiaFW-stt-settings-toggle-opt-fr', 
				function(){
					SepiaFW.speechAudioProcessor.setOptimizeFinalResult(true);
					SepiaFW.debug.info("STT Server 'optimizeFinalResult' is 'true'");
				},function(){
					SepiaFW.speechAudioProcessor.setOptimizeFinalResult(false);
					SepiaFW.debug.info("STT Server 'optimizeFinalResult' is 'false'");
				}, SepiaFW.speechAudioProcessor.getOptimizeFinalResult()
			));
		},
		
		onOpen: function(){
			$('#sepiaFW-stt-settings-server-engine').text(SepiaFW.speech.getAsrEngine());
			$('#sepiaFW-stt-settings-server-url').val(SepiaFW.speechAudioProcessor.getSocketURI());
			$('#sepiaFW-stt-settings-server-user').val(SepiaFW.speechAudioProcessor.serverUser || "");
			$('#sepiaFW-stt-settings-server-token').val(SepiaFW.speechAudioProcessor.serverToken || "");	//TODO: replace with input only?
			$('#sepiaFW-stt-settings-language').text(SepiaFW.speech.getLanguage());
			//model options
			var modelOptionsSelect = $('#sepiaFW-stt-settings-asr-model')[0];
			SepiaFW.speechAudioProcessor.getServerSettings(function(settings){
				modelOptionsSelect.innerHTML = "<option value=''>Default</option>";
				var models = (settings && settings.models)? settings.models : [];
				models.forEach(function(m){
					var opt = document.createElement("option");
					opt.value = m;
					opt.textContent = m;
					modelOptionsSelect.appendChild(opt);
				});
				modelOptionsSelect.value = SepiaFW.speechAudioProcessor.getActiveAsrModel() || "";
			}, function(err){
				modelOptionsSelect.innerHTML = "<option value='' disabled selected>-Not found-</option>";
			});
			//optimize result?
			var optFinalResToggle = $('#sepiaFW-stt-settings-toggle-opt-fr').get(0);
			optFinalResToggle.setValue(SepiaFW.speechAudioProcessor.getOptimizeFinalResult());
			//enable/disable options
			if (SepiaFW.speech.getAsrEngine() != "sepia"){
				SepiaFW.frames.currentScope.showInfo("Note: Most options only apply to 'sepia' engine atm.");
				$('#sepiaFW-stt-settings-server-info-btn').hide();
				optFinalResToggle.setDisabled(true);
			}else{
				SepiaFW.frames.currentScope.showInfo("Note: 'Optimize final result' is still experimental.");
				$('#sepiaFW-stt-settings-server-info-btn').show();
				optFinalResToggle.setDisabled(false);
			}
			//set global speech listener
			SepiaFW.speech.setActiveGlobalSpeechEventListener(function(ev){
				if (SepiaFW.frames.currentScope.speechEvents) SepiaFW.frames.currentScope.speechEvents(ev);
			});
			SepiaFW.audioRecorder.debugInterfaces = true;
			SepiaFW.audioRecorder.debuggerLogFunction = SepiaFW.frames.currentScope.audioRecorderEvents;
			SepiaFW.frames.currentScope.resetRecognizer();
		},

		onClose: function(){
			//Update settings
			$('#sepiaFW-menu-stt-socket-url').val(SepiaFW.speechAudioProcessor.getSocketURI());
			//remove global speech listener
			SepiaFW.speech.setActiveGlobalSpeechEventListener(undefined);
			SepiaFW.audioRecorder.debugInterfaces = false;
			SepiaFW.audioRecorder.debuggerLogFunction = undefined;
		},

		showServerInfo: function(){
			SepiaFW.frames.currentScope.showInfo("Loading server info...");
			SepiaFW.speechAudioProcessor.getServerSettings(function(settings){
				var msg = "Server info:\n\n";
				Object.keys(settings).forEach(function(k){
					msg += k + " = " + settings[k] + "\n";
				});
				SepiaFW.frames.currentScope.showInfo(msg);
			}, function(err){
				SepiaFW.frames.currentScope.showError("Failed to load server info.");
			});
		},

		showInfo: function(msg){
			$('#sepiaFW-stt-settings-info-msg').css("color", "").text(msg);
		},
		showError: function(msg){
			$('#sepiaFW-stt-settings-info-msg').css("color", "#f00").text(msg);
		},

		//Debugger page

		debuggerState: {
			tic: 0
		},

		showDebugMsg: function(msg, isError, color){
			var msgEle = document.createElement("p");
			msgEle.textContent = (Date.now() - SepiaFW.frames.currentScope.debuggerState.tic) + " - " + msg;
			msgEle.style.margin = "5px 0";
			if (color) msgEle.style.color = color;
			else if (isError) msgEle.style.color = "#f00";
			var $msgBox = $('#sepiaFW-stt-settings-debug-log');
			$msgBox.append(msgEle);
			$msgBox[0].scrollTop = $msgBox[0].scrollHeight;
		},
		clearSttDebugBox: function(){
			$('#sepiaFW-stt-settings-debug-log').html("");
		},
		
		speechEvents: function(ev){
			console.log("SpeechEvent", ev);		//DEBUG
		},
		audioRecorderEvents: function(logTag, args){
			if (logTag && (!args || !args.length)){
				SepiaFW.frames.currentScope.showDebugMsg(logTag, false, "#00d4d4");
				return;
			}
			var msg = "";
			for (let i=0; i<args.length; i++){
				msg += args[i] + " ";
			}
			SepiaFW.frames.currentScope.showDebugMsg(logTag + " " + msg.trim(), false, "#00bcd4");
		},
		onAnimationStateChange: function(state){
			SepiaFW.frames.currentScope.showDebugMsg("AnimationState: " + state, false, "#cddc39");
		},

		toggleRecordingWithConfirmSound: function(){
			if (SepiaFW.speech.isRecognizing()){
				SepiaFW.frames.currentScope.showDebugMsg("---Stop request---");
				SepiaFW.frames.currentScope.toggleRecording();
			}else{
				SepiaFW.frames.currentScope.debuggerState.tic = Date.now();
				SepiaFW.frames.currentScope.showDebugMsg("---Start request---");
				SepiaFW.frames.currentScope.showDebugMsg("Engine: " + SepiaFW.speech.getAsrEngine());
				var useConfirmationSound = SepiaFW.speech.shouldPlayConfirmation();
				if (useConfirmationSound){
					SepiaFW.frames.currentScope.showDebugMsg("AUDIO confirm sound play");
					SepiaFW.audio.playURL(SepiaFW.audio.micConfirmSound, '2', '', function(){
						SepiaFW.frames.currentScope.showDebugMsg("AUDIO confirm sound end");
						SepiaFW.frames.currentScope.toggleRecording();
					}, SepiaFW.client.asrErrorCallback);
				}else{
					SepiaFW.frames.currentScope.toggleRecording();
				}
			}
		},
		toggleRecording: function(){
			SepiaFW.speech.toggleRecognition(function(finalRes){
				SepiaFW.frames.currentScope.showDebugMsg("Final res.: " + finalRes);
			}, function(interimRes){
				SepiaFW.frames.currentScope.showDebugMsg("Partial res.: " + interimRes);
			}, function(err){
				var cleanErr = {message: "undefined error"};
				if (!err) err = cleanErr;
				if (typeof err == "string") cleanErr.message = err;
				else if (err.message) cleanErr.message = err.message;
				SepiaFW.frames.currentScope.showDebugMsg(cleanErr.message, true);
			}, function(logMsg){
				SepiaFW.frames.currentScope.showDebugMsg(logMsg);
			});
		},
		resetRecognizer: function(){
			if (!SepiaFW.speech.isSpeakingOrListening()){
				SepiaFW.speech.resetRecognition(undefined, SepiaFW.frames.currentScope.audioRecorderEvents);
			}else{
				SepiaFW.speech.stopRecognition();
			}
		}
	}
</script>